import os

from API_dataphonia_custom.dataphonia import Dataphonia
from API_dataphonia_custom.utils import choisir_projet, choisir_fichier_dans_projet, normalize_bucket_name

import csv


def afficher_metadonnees(client):
    """Affiche les m√©tadonn√©es d'un fichier dans un projet s√©lectionn√©."""
    project_id, project_name = choisir_projet(client)
    if not project_id:
        return

    file_name = choisir_fichier_dans_projet(client, project_id)
    if not file_name:
        return

    files = client.get_all_files(project_id)
    file_selected = next((f for f in files if f["name"] == file_name), None)

    metadata = file_selected.get("metadata", {})
    print(f"\nüìù M√©tadonn√©es du fichier {file_selected['name']} dans {project_name}:")
    if not metadata:
        print("‚ùå Aucune m√©tadonn√©e disponible.")
    else:
        for key, value in metadata.items():
            print(f"{key}: {value}")


def parcourir_et_uploader(client, directory, bucket_name):
    """Parcourt un r√©pertoire et upload tous les fichiers trouv√©s vers S3."""
    if not os.path.exists(directory):
        print(f"‚ùå Le dossier {directory} n'existe pas.")
        return

    for root, _, files in os.walk(directory):
        for file in files:
            if file.startswith("."):  # Ignore les fichiers syst√®me comme .DS_Store sur macOS
                continue

            file_path = os.path.join(root, file)
            key_name = os.path.relpath(file_path, start=directory)

            print(f"üì§ Upload du fichier : {file_path} ‚Üí S3: {bucket_name}/{key_name}")
            client.upload_file(file_path, bucket_name, key_name)


def uploader_fichier(client):
    """Upload d'un fichier ou dossier apr√®s choix du projet"""
    project_id, bucket_name = choisir_projet(client)
    if not project_id or not bucket_name:
        return

    choix = input("\nVoulez-vous uploader (1) un fichier ou (2) un dossier ? ")

    if choix == "1":
        file_path = input("Entrez le chemin du fichier √† uploader : ")
        if not os.path.isfile(file_path):
            print("‚ùå Le fichier sp√©cifi√© n'existe pas.")
            return

        key_name = os.path.basename(file_path)  # Nom du fichier comme cl√© S3

        if client.upload_file(file_path, bucket_name, key_name):
            print(f"‚úÖ Fichier {file_path} upload√© avec succ√®s dans {bucket_name}/{key_name}.")
        else:
            print("‚ùå √âchec de l'upload.")

    elif choix == "2":
        dir_path = input("Entrez le chemin du dossier contenant les fichiers √† uploader : ")
        parcourir_et_uploader(client, dir_path, bucket_name)

    else:
        print("‚ùå Option invalide.")



def telecharger_fichier(client):
    """T√©l√©charge un fichier depuis un projet s√©lectionn√©."""
    project_id, bucket_name = choisir_projet(client)
    if not project_id:
        return

    file_name = choisir_fichier_dans_projet(client, project_id)
    if not file_name:
        return

    save_dir = "downloads"
    os.makedirs(save_dir, exist_ok=True)
    save_path = os.path.join(save_dir, file_name)

    try:
        if client.download_file(project_id,bucket_name, file_name, save_path):
            print(f"‚úÖ Fichier t√©l√©charg√© avec succ√®s: {save_path}")
        else:
            print("‚ùå Le t√©l√©chargement a √©chou√©.")
    except FileNotFoundError:
        print("‚ùå Erreur: Chemin de sauvegarde invalide.")



def telecharger_tout(client):
    """T√©l√©charge tous les fichiers d'un projet s√©lectionn√©, sauf s'ils existent d√©j√†."""
    project_id, bucket_name = choisir_projet(client)
    if not project_id:
        return

    save_dir = "downloads"
    os.makedirs(save_dir, exist_ok=True)

    # R√©cup√©rer tous les fichiers du projet
    files = client.get_all_files(project_id)

    if not files:
        print("‚ùå Aucun fichier √† t√©l√©charger dans ce projet.")
        return

    print(f"üì• T√©l√©chargement de {len(files)} fichiers depuis le projet {project_id}...")

    for file_info in files:
        file_name = file_info["name"]
        save_path = os.path.join(save_dir, file_name)

        # V√©rifier si le fichier existe d√©j√†
        if os.path.exists(save_path):
            print(f"‚è© Fichier d√©j√† existant, t√©l√©chargement ignor√© : {file_name}")
            continue

        try:
            if client.download_file(project_id, bucket_name, file_name, save_path):
                print(f"‚úÖ Fichier t√©l√©charg√© : {save_path}")
            else:
                print(f"‚ùå √âchec du t√©l√©chargement : {file_name}")

        except FileNotFoundError:
            print(f"‚ùå Erreur : Impossible de sauvegarder {file_name}")

    print("üéâ T√©l√©chargement termin√© !")

def sauvegarder_metadonnees_csv(client):
    """
    R√©cup√®re les m√©tadonn√©es de tous les fichiers d'un projet s√©lectionn√© et les enregistre dans un fichier CSV.
    """
    project_id, project_name = choisir_projet(client)
    if not project_id:
        return
    
    files = client.get_all_files(project_id)
    if not files:
        print("‚ùå Aucun fichier trouv√© dans le projet.")
        return
    
    # Exclure l'attribut 'metadata'
    colonnes_exclues = ["metadata"]
    colonnes = list(files[0].keys()) if isinstance(files[0], dict) else []
    colonnes = [col for col in colonnes if col not in colonnes_exclues]
    
    output_dir = "output"
    os.makedirs(output_dir, exist_ok=True)
    output_file = os.path.join(output_dir, "metadonnees_fichiers.csv")
    
    with open(output_file, "w", newline="", encoding="utf-8") as f:
        writer = csv.DictWriter(f, fieldnames=colonnes)
        writer.writeheader()
        
        for file_info in files:
            if not isinstance(file_info, dict):
                print(f"‚ö†Ô∏è Avertissement: Un fichier r√©cup√©r√© n'est pas un dictionnaire: {file_info}")
                continue
            
            filtered_info = {k: file_info.get(k, None) for k in colonnes}
            writer.writerow(filtered_info)
    
    print(f"‚úÖ M√©tadonn√©es sauvegard√©es dans {output_file}")

def main():

    print("CHOIX DE FICHIERS A TELECHARGER POUR PRE-ANALYSE.")
    client = Dataphonia()  # Connexion g√©r√©e dans `dataphonia.py`

    #telecharger_tout(client)

    
    sauvegarder_metadonnees_csv(client)

    '''
    while True:
         print("\n---------------------- Menu --------------------------")
         print("1. Afficher les m√©tadonn√©es d'un fichier")
         print("2. Uploader un fichier")
         print("3. T√©l√©charger un fichier depuis 'super-mega-projet-de-test'")
         print("2. Uploader un fichier ou un dossier")
         print("3. T√©l√©charger un fichier")
         print("4. Quitter")
         
 
         choix = input("Choisissez une option : ")
         if choix == "1":
             afficher_metadonnees(client)
         elif choix == "3":
             telecharger_fichier(client)
         elif choix == "4":
             print("Au revoir!")
             print("üëã Au revoir!")
             break
         else:
             print("Option invalide, veuillez r√©essayer.")
             print("‚ùå Option invalide, veuillez r√©essayer.")
        '''

if __name__ == "__main__":
    main()
